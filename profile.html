<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Профиль игрока</title>
  <style>
    body {
      background: #f5f7fa;
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
    }
    .profile-container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    /* Верхний блок с аватаром и инфой */
    .profile-header {
      display: flex;
      gap: 20px;
    }
    .left-column {
      flex: 1 1 30%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .left-column img {
      width: 100%;
      max-width: 200px;
      border-radius: 12px;
      object-fit: cover;
      background: #f0f0f0;
    }
    .nickname {
      margin-top: 8px;
      font-weight: bold;
      font-size: 1.3em;
      text-align: center;
    }
    .right-column {
      flex: 1 1 70%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      font-size: 1em;
    }
    /* Нижний блок с двумя списками */
    .content-lists {
      display: flex;
      gap: 20px;
      height: 320px; /* фиксированная высота для прокрутки */
    }
    .ratings-list, .achievements-list {
      background: #fafafa;
      border-radius: 10px;
      padding: 12px;
      overflow-y: auto;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    /* Левая часть - оценки */
    .ratings-list {
      flex: 1 1 45%;
    }
    /* Правая часть - достижения */
    .achievements-list {
      flex: 1 1 55%;
    }
    /* Элементы оценок игр */
    .game-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .game-item img {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
    }
    .game-item-info {
      display: flex;
      flex-direction: column;
    }
    /* Элементы достижений */
    .steam-achievement {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      align-items: center;
    }
    .medal-icon {
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }
    .achievement-details h4 {
      margin: 0 0 6px 0;
      font-size: 1.1em;
    }
    .progress-bar {
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
      height: 8px;
      margin: 4px 0;
      width: 100%;
    }
    .progress-bar .progress {
      background: linear-gradient(to right, gold, orange);
      height: 100%;
    }
    button {
      align-self: center;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      margin-top: 10px;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div id="profile-content">Загрузка...</div>
    <button onclick="window.history.back()">⬅ Назад</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBNuHz-OPbVWHoc7gtuxHU21-CC5TbYKbw",
      authDomain: "game-idg.firebaseapp.com",
      projectId: "game-idg",
      storageBucket: "game-idg.appspot.com",
      messagingSenderId: "987199066254",
      appId: "1:987199066254:web:ed82cea15f4a7b7a4279df",
      measurementId: "G-QLLFXDHX51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const uid = params.get("uid");

    if (!uid) {
      document.getElementById("profile-content").innerHTML = "<p>Пользователь не найден.</p>";
    } else {
      loadProfile(uid);
    }

    function getMedalLevel(value, bronze, silver, gold) {
      if (value >= gold) return { level: "Золото" };
      if (value >= silver) return { level: "Серебро" };
      if (value >= bronze) return { level: "Бронза" };
      return { level: "Нет" };
    }
    function getMedalIconPath(key, level) {
      const base = `assets/medals/${key}`;
      switch (level) {
        case "Золото": return `${base}/gold.png`;
        case "Серебро": return `${base}/silver.png`;
        case "Бронза": return `${base}/bronze.png`;
        default: return `${base}/locked.png`;
      }
    }
    function onErrorImg(e){ e.target.onerror = null; e.target.src = 'assets/default-avatar.png'; }

    async function loadProfile(uid) {
      const userSnapshot = await getDocs(query(collection(db, "users"), where("uid", "==", uid)));
      if (userSnapshot.empty) {
        document.getElementById("profile-content").innerHTML = "<p>Профиль не найден.</p>";
        return;
      }
      const userDoc = userSnapshot.docs[0];
      const userData = userDoc.data();

      const gamesSnapshot = await getDocs(collection(db, "games"));
      const totalGames = gamesSnapshot.size || 0;

      const ratingsSnapshot = await getDocs(query(collection(db, "ratings"), where("userId", "==", uid)));
      const ratings = ratingsSnapshot.docs.map(d => d.data());
      const percentComplete = totalGames ? Math.round((ratings.length / totalGames) * 100) : 0;
      const avgRating = ratings.length ? (ratings.reduce((a,b) => a + b.rating, 0) / ratings.length).toFixed(1) : "—";

      const gamesArr = gamesSnapshot.docs.map(g => ({ id: g.id, ...g.data() }));
      const genresSet = new Set();
      const genreCount = {};
      ratings.forEach(r => {
        const game = gamesArr.find(g => g.id === r.gameId);
        if (game && game.category) {
          const cats = Array.isArray(game.category) ? game.category : [game.category];
          cats.forEach(cat => {
            genresSet.add(cat);
            genreCount[cat] = (genreCount[cat] || 0) + 1;
          });
        }
      });
      const genresCount = genresSet.size;
      let favGenrePercent = 0;
      if (userData.favoriteGenre && ratings.length) {
        favGenrePercent = Math.round(((genreCount[userData.favoriteGenre] || 0) / ratings.length) * 100);
      }

      const userStats = {
        percentComplete,
        ratingsCount: ratings.length,
        genresCount,
        favGenrePercent
      };

      let ratedGamesHTML = "";
      for (const r of ratings) {
        const gameDoc = gamesSnapshot.docs.find(g => g.id === r.gameId);
        if (!gameDoc) continue;
        const game = gameDoc.data();
        ratedGamesHTML += `
          <div class="game-item">
            <img src="${game.image}" alt="${game.title}" onerror="this.onerror=null; this.src='assets/default-game.png'">
            <div class="game-item-info">
              <strong>${game.title}</strong>
              <span>${r.rating} ⭐</span>
            </div>
          </div>
        `;
      }

      document.getElementById("profile-content").innerHTML = `
        <div class="profile-header">
          <div class="left-column">
            <img id="profile-main-avatar" src="${userData.avatar || 'assets/default-avatar.png'}" alt="Аватар">
            <div class="nickname">${userData.nickname}</div>
          </div>
          <div class="right-column">
            <p><strong>Любимый жанр:</strong> ${userData.favoriteGenre || "—"}</p>
            <p><strong>Пройдено:</strong> ${percentComplete}%</p>
            <p><strong>Средняя оценка:</strong> ${avgRating}</p>
          </div>
        </div>

        <div class="content-lists">
          <div class="ratings-list">
            <h3>Оцененные игры</h3>
            ${ratedGamesHTML || "<p>Нет оценок.</p>"}
          </div>
          <div class="achievements-list" id="profile-achievements-right"></div>
        </div>
      `;

      const mainAvatar = document.getElementById("profile-main-avatar");
      mainAvatar.onerror = onErrorImg;

      renderProfileAchievements(document.getElementById("profile-achievements-right"), { ...userStats, favoriteGenre: userData.favoriteGenre });
    }

    function renderProfileAchievements(container, userStats) {
      const achList = [
        { key:"master", name:"Мастер прохождений", desc:"Пройди как можно больше игр", value:userStats.percentComplete, bronze:20, silver:50, gold:80, unit:"%" },
        { key:"critic", name:"Критик", desc:"Оценивай игры и становись признанным критиком", value:userStats.ratingsCount, bronze:10, silver:30, gold:50, unit:"" },
        { key:"genres", name:"Коллекционер жанров", desc:"Играй в разные жанры и расширяй кругозор", value:userStats.genresCount, bronze:8, silver:13, gold:20, unit:"" },
        { key:"favgenre", name:"Любимчик жанра", desc:"Будь преданным фанатом своего любимого жанра", value:userStats.favGenrePercent, bronze:25, silver:50, gold:80, unit:"%" }
      ];

      let html = `<div class="achievements-list steam-achievements">`;
      achList.forEach(a => {
        const medal = getMedalLevel(a.value, a.bronze, a.silver, a.gold);
        const icon = getMedalIconPath(a.key, medal.level);
        const nextTarget = medal.level === "Золото" ? null
          : medal.level === "Серебро" ? a.gold
          : medal.level === "Бронза" ? a.silver : a.bronze;
        const progressPercent = nextTarget ? Math.min(100, Math.round((a.value / nextTarget) * 100)) : 100;
        const progressText = nextTarget ? `${a.value}${a.unit} из ${nextTarget}${a.unit}` : `${a.value}${a.unit} (макс. уровень)`;

        html += `
          <div class="steam-achievement">
            <img class="medal-icon" src="${icon}" alt="${a.name}" onerror="this.onerror=null; this.src='assets/medals/locked.png'">
            <div class="achievement-details">
              <h4>${a.name} <span class="level">— ${medal.level}</span></h4>
              <p>${a.desc}</p>
              <div class="progress-bar"><div class="progress" style="width:${progressPercent}%"></div></div>
              <small>${progressText}</small>
            </div>
          </div>
        `;
      });
      html += `</div>`;
      container.innerHTML = html;
    }
  </script>
</body>
</html>
